# GitHub Actions workflow for building and publishing Docker images
#
# This workflow handles:
# 1. PR validation: Build images to verify Dockerfiles work correctly
# 2. Release builds: Build and push multi-arch images on tag push
# 3. Main branch builds: Build and push images with 'latest' tag
#
# Images are pushed to GitHub Container Registry (ghcr.io)
#
# Triggers:
# - Pull requests: Build only (no push) for validation
# - Push to main: Build and push with 'latest' tag
# - Tag push (v*): Build and push with version tag
#
# Images built:
# - ghcr.io/${{ github.repository_owner }}/zstack-ovnkube-controller
# - ghcr.io/${{ github.repository_owner }}/zstack-ovnkube-node
# - ghcr.io/${{ github.repository_owner }}/zstack-ovn-cni
#
# Requirements: 10.3

name: Build and Push Docker Images

on:
  # Trigger on pull requests to main branch
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'cmd/**'
      - 'pkg/**'
      - 'api/**'
      - 'Dockerfile.*'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/build-images.yaml'

  # Trigger on push to main branch (with path filter)
  # and on tag push (without path filter - all tags trigger build)
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
    # Note: paths filter only applies to branch pushes, not tag pushes
    # This means all v* tags will trigger the workflow regardless of changed files
    paths:
      - 'cmd/**'
      - 'pkg/**'
      - 'api/**'
      - 'Dockerfile.*'
      - 'go.mod'
      - 'go.sum'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push images to registry'
        required: false
        default: 'false'
        type: boolean

# Environment variables used across all jobs
env:
  # Default registry is GitHub Container Registry
  REGISTRY: ghcr.io
  # Image names
  CONTROLLER_IMAGE: zstack-ovnkube-controller
  NODE_IMAGE: zstack-ovnkube-node
  CNI_IMAGE: zstack-ovn-cni
  # Platforms for multi-arch builds
  PLATFORMS: linux/amd64,linux/arm64

# Concurrency settings to avoid duplicate builds
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Job: Build and Test
  # Runs on all triggers to validate the build
  # ==========================================================================
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./pkg/...

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.out
          retention-days: 7

  # ==========================================================================
  # Job: Build Docker Images
  # Builds multi-arch images and optionally pushes to registry
  # ==========================================================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-test
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        include:
          - image: zstack-ovnkube-controller
            dockerfile: Dockerfile.controller
          - image: zstack-ovnkube-node
            dockerfile: Dockerfile.node
          - image: zstack-ovn-cni
            dockerfile: Dockerfile.cni

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Determine if we should push images
      # Push on: main branch push, tag push, or manual trigger with push_images=true
      - name: Determine push flag
        id: push-flag
        run: |
          PUSH="false"
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            PUSH="true"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/master" ]]; then
            PUSH="true"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            PUSH="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.push_images }}" == "true" ]]; then
            PUSH="true"
          fi
          echo "push=$PUSH" >> $GITHUB_OUTPUT
          echo "Push images: $PUSH"

      # Extract metadata for Docker image tags
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}
          tags: |
            # Set 'latest' tag for main branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
            # Set version tag for releases (v1.0.0 -> 1.0.0)
            type=semver,pattern={{version}}
            # Set major.minor tag (v1.0.0 -> 1.0)
            type=semver,pattern={{major}}.{{minor}}
            # Set major tag (v1.0.0 -> 1)
            type=semver,pattern={{major}}
            # Set SHA tag for all builds
            type=sha,prefix=sha-
            # Set branch name tag for branch builds
            type=ref,event=branch
            # Set PR number tag for PR builds
            type=ref,event=pr

      # Set up QEMU for multi-arch builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Set up Docker Buildx for multi-arch builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to GitHub Container Registry
      # Only login when we need to push
      - name: Login to GitHub Container Registry
        if: steps.push-flag.outputs.push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Get version information for build args
      - name: Get version info
        id: version
        run: |
          VERSION="dev"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
          elif [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" ]]; then
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "git_commit=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      # Build and push Docker image
      - name: Build and push ${{ matrix.image }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: ${{ env.PLATFORMS }}
          push: ${{ steps.push-flag.outputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            GIT_COMMIT=${{ steps.version.outputs.git_commit }}
            BUILD_DATE=${{ steps.version.outputs.build_date }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Output image digest for verification
      - name: Image digest
        run: |
          echo "Image: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}"
          echo "Tags: ${{ steps.meta.outputs.tags }}"

  # ==========================================================================
  # Job: Create Release (only on tag push)
  # Creates a GitHub release with release notes
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-images
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release-notes
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since $PREV_TAG" > release-notes.md
            echo "" >> release-notes.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> release-notes.md
          else
            echo "## Initial Release" > release-notes.md
            echo "" >> release-notes.md
            echo "First release of zstack-ovn-kubernetes CNI plugin." >> release-notes.md
          fi
          
          # Add image information
          echo "" >> release-notes.md
          echo "## Docker Images" >> release-notes.md
          echo "" >> release-notes.md
          echo "Pull the images from GitHub Container Registry:" >> release-notes.md
          echo "" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.CONTROLLER_IMAGE }}:${{ github.ref_name }}" >> release-notes.md
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.NODE_IMAGE }}:${{ github.ref_name }}" >> release-notes.md
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.CNI_IMAGE }}:${{ github.ref_name }}" >> release-notes.md
          echo "\`\`\`" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Job: Notify (optional - for Slack/Discord notifications)
  # ==========================================================================
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-test, build-images]
    if: always()
    
    steps:
      - name: Build Status Summary
        run: |
          echo "## Build Summary"
          echo "- Build and Test: ${{ needs.build-test.result }}"
          echo "- Build Images: ${{ needs.build-images.result }}"
          echo ""
          if [[ "${{ needs.build-test.result }}" == "success" && "${{ needs.build-images.result }}" == "success" ]]; then
            echo "✅ All jobs completed successfully!"
          else
            echo "❌ Some jobs failed. Please check the logs."
            exit 1
          fi
