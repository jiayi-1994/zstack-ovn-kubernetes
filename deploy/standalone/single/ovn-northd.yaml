# OVN Northd - Single Replica Deployment
# northd is the central component that translates high-level network configuration
# from NB DB into logical flows in SB DB
#
# Key responsibilities:
# - Reads logical network configuration from NB DB
# - Computes logical flows based on the configuration
# - Writes logical flows to SB DB
# - Handles network topology changes
#
# Reference: OVN-Kubernetes deployment patterns
# Image: Official OVN-Kubernetes image from ghcr.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ovn-northd
  namespace: ovn-kubernetes
  labels:
    app.kubernetes.io/name: ovn-northd
    app.kubernetes.io/component: control-plane
spec:
  replicas: 1
  strategy:
    type: Recreate  # Single instance for simplicity
  selector:
    matchLabels:
      app.kubernetes.io/name: ovn-northd
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ovn-northd
        app.kubernetes.io/component: control-plane
    spec:
      # Run on control-plane nodes for stability
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists

      # Wait for NB and SB databases to be ready
      initContainers:
        - name: wait-for-dbs
          image: ghcr.io/ovn-org/ovn-kubernetes/ovn-kube-ubuntu:master
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -c
            - |
              set -ex
              echo "Waiting for OVN NB DB to be ready..."
              until ovsdb-client list-dbs tcp:ovn-nb-db.ovn-kubernetes.svc.cluster.local:6641 2>/dev/null | grep -q OVN_Northbound; do
                echo "NB DB not ready, waiting..."
                sleep 2
              done
              echo "NB DB is ready!"
              
              echo "Waiting for OVN SB DB to be ready..."
              until ovsdb-client list-dbs tcp:ovn-sb-db.ovn-kubernetes.svc.cluster.local:6642 2>/dev/null | grep -q OVN_Southbound; do
                echo "SB DB not ready, waiting..."
                sleep 2
              done
              echo "SB DB is ready!"
      containers:
        - name: ovn-northd
          # Using official OVN-Kubernetes image
          image: ghcr.io/ovn-org/ovn-kubernetes/ovn-kube-ubuntu:master
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -c
            - |
              set -ex
              
              # Define database connection strings
              OVN_NB_DB="tcp:ovn-nb-db.ovn-kubernetes.svc.cluster.local:6641"
              OVN_SB_DB="tcp:ovn-sb-db.ovn-kubernetes.svc.cluster.local:6642"
              
              echo "Starting OVN northd..."
              echo "NB DB: ${OVN_NB_DB}"
              echo "SB DB: ${OVN_SB_DB}"
              
              # Start northd daemon
              # --ovn-northd-nb-db: Connection string for NB DB
              # --ovn-northd-sb-db: Connection string for SB DB
              # -vconsole:info: Log to console at info level
              exec ovn-northd \
                --ovn-northd-nb-db="${OVN_NB_DB}" \
                --ovn-northd-sb-db="${OVN_SB_DB}" \
                -vconsole:info \
                --pidfile=/var/run/ovn/ovn-northd.pid \
                --no-chdir
          env:
            - name: OVN_NB_DB
              value: "tcp:ovn-nb-db.ovn-kubernetes.svc.cluster.local:6641"
            - name: OVN_SB_DB
              value: "tcp:ovn-sb-db.ovn-kubernetes.svc.cluster.local:6642"
          volumeMounts:
            - name: ovn-run
              mountPath: /var/run/ovn
          livenessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  # Check if northd process is running
                  pgrep -f ovn-northd > /dev/null
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      volumes:
        - name: ovn-run
          emptyDir: {}
