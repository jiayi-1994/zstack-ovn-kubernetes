# ZStack OVN Kubernetes CNI 技术文档

## 目录

1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [核心组件详解](#3-核心组件详解)
4. [数据流程图](#4-数据流程图)
5. [部署模式](#5-部署模式)
6. [核心功能实现](#6-核心功能实现)
7. [API 参考](#7-api-参考)
8. [配置参考](#8-配置参考)
9. [运维指南](#9-运维指南)

---

## 1. 项目概述

### 1.1 项目背景

zstack-ovn-kubernetes 是一个基于 OVN (Open Virtual Networking) 的 Kubernetes CNI 插件，专为 ZStack IaaS 平台设计。该项目参考 OVN-Kubernetes 的成熟架构，从零开发实现，旨在提供：

- **VM 与 Pod 网络互通**: 在统一的 OVN 网络平面中实现 ZStack 虚拟机与 Kubernetes Pod 的无缝通信
- **双模式部署**: 支持独立部署 (Standalone) 和接入 ZStack OVN (External) 两种模式
- **完整的 K8s 网络功能**: Pod-to-Pod、Pod-to-Service、NetworkPolicy 全场景支持

### 1.2 核心特性

| 特性 | 描述 |
|------|------|
| **Overlay 网络** | 基于 VXLAN 隧道的虚拟网络 |
| **Underlay 网络** | 直接使用物理网络 (VLAN) |
| **Service 负载均衡** | 基于 OVN Load Balancer 实现 |
| **NetworkPolicy** | 基于 OVN ACL 实现网络策略 |
| **双模式部署** | Standalone 和 External 模式 |
| **高可用** | 支持 OVN 数据库 Raft 集群 |
| **DPDK 支持** | 高性能网络加速 (可选) |

### 1.3 技术栈


```
┌─────────────────────────────────────────────────────────────┐
│                      技术栈                                  │
├─────────────────────────────────────────────────────────────┤
│  语言: Go 1.21+                                              │
│  框架: controller-runtime, libovsdb, containernetworking/cni │
│  数据库: OVN NB/SB (OVSDB)                                   │
│  数据平面: Open vSwitch                                      │
│  部署: Helm, Kustomize, YAML                                 │
│  测试: Go testing, gopter (属性测试)                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                         Control Plane (Master)                              │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │ │
│  │  │              zstack-ovnkube-controller (Deployment)                   │  │ │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────────────┐  │  │ │
│  │  │  │   Subnet    │ │   Service   │ │   Policy    │ │      Node      │  │  │ │
│  │  │  │ Controller  │ │ Controller  │ │ Controller  │ │   Controller   │  │  │ │
│  │  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └───────┬────────┘  │  │ │
│  │  │         │               │               │                │           │  │ │
│  │  │         └───────────────┴───────────────┴────────────────┘           │  │ │
│  │  │                                │                                      │  │ │
│  │  │                         ┌──────┴──────┐                              │  │ │
│  │  │                         │  OVN Client │                              │  │ │
│  │  │                         │  (libovsdb) │                              │  │ │
│  │  │                         └──────┬──────┘                              │  │ │
│  │  └────────────────────────────────┼──────────────────────────────────────┘  │ │
│  └───────────────────────────────────┼──────────────────────────────────────────┘ │
│                                      │                                            │
│                                      ▼                                            │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │                         OVN Database Layer                                  │  │
│  │  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │  │
│  │  │     Standalone Mode         │  │      External Mode (ZStack)         │  │  │
│  │  │  ┌─────────┐ ┌─────────┐   │  │  ┌─────────────────────────────────┐ │  │  │
│  │  │  │  NB DB  │ │  SB DB  │   │  │  │   ZStack OVN NB/SB Database     │ │  │  │
│  │  │  │ (6641)  │ │ (6642)  │   │  │  │   (External Connection)         │ │  │  │
│  │  │  └────┬────┘ └────┬────┘   │  │  └─────────────────────────────────┘ │  │  │
│  │  │       │           │        │  │                                      │  │  │
│  │  │  ┌────┴───────────┴────┐   │  │                                      │  │  │
│  │  │  │       northd        │   │  │                                      │  │  │
│  │  │  └─────────────────────┘   │  │                                      │  │  │
│  │  └─────────────────────────────┘  └─────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │                           Worker Node                                       │  │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │  │
│  │  │              zstack-ovnkube-node (DaemonSet)                          │  │  │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                     │  │  │
│  │  │  │    Node     │ │   Gateway   │ │   Tunnel    │                     │  │  │
│  │  │  │  Network    │ │  Controller │ │  Controller │                     │  │  │
│  │  │  │ Controller  │ │             │ │   (VXLAN)   │                     │  │  │
│  │  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                     │  │  │
│  │  │         │               │               │                            │  │  │
│  │  │  ┌──────┴───────────────┴───────────────┴──────┐                     │  │  │
│  │  │  │              CNI Server (Unix Socket)        │                     │  │  │
│  │  │  └──────────────────────┬───────────────────────┘                     │  │  │
│  │  └─────────────────────────┼─────────────────────────────────────────────┘  │  │
│  │                            │                                                │  │
│  │  ┌─────────────────────────┼─────────────────────────────────────────────┐  │  │
│  │  │                         ▼                                              │  │  │
│  │  │  ┌──────────────────────────────────────────────────────────────────┐ │  │  │
│  │  │  │              zstack-ovn-cni (CNI Binary)                          │ │  │  │
│  │  │  │  /opt/cni/bin/zstack-ovn-cni                                      │ │  │  │
│  │  │  └──────────────────────────────────────────────────────────────────┘ │  │  │
│  │  │                                                                        │  │  │
│  │  │  ┌──────────────────────────────────────────────────────────────────┐ │  │  │
│  │  │  │                    OVS + ovn-controller                           │ │  │  │
│  │  │  │  ┌─────────┐  ┌─────────┐  ┌─────────────────────────────────┐   │ │  │  │
│  │  │  │  │ br-int  │──│ br-ex   │──│ Physical NIC (eth0/bond0)       │   │ │  │  │
│  │  │  │  └────┬────┘  └─────────┘  └─────────────────────────────────┘   │ │  │  │
│  │  │  │       │                                                           │ │  │  │
│  │  │  │  ┌────┴────┐  ┌─────────┐  ┌─────────┐                           │ │  │  │
│  │  │  │  │ veth-xx │  │ veth-yy │  │ vxlan0  │                           │ │  │  │
│  │  │  │  │ (Pod A) │  │ (Pod B) │  │(Tunnel) │                           │ │  │  │
│  │  │  │  └─────────┘  └─────────┘  └─────────┘                           │ │  │  │
│  │  │  └──────────────────────────────────────────────────────────────────┘ │  │  │
│  │  └────────────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 组件职责表

| 组件 | 部署方式 | 职责 | 关键文件 |
|------|----------|------|----------|
| **zstack-ovnkube-controller** | Deployment (1-3 副本) | 监听 K8s API，管理 OVN 逻辑对象 | `cmd/zstack-ovnkube-controller/main.go` |
| **zstack-ovnkube-node** | DaemonSet (每节点) | 节点网络配置，CNI Server | `cmd/zstack-ovnkube-node/main.go` |
| **zstack-ovn-cni** | 二进制文件 | CNI 插件，处理 ADD/DEL/CHECK | `cmd/zstack-ovn-cni/main.go` |
| **OVN NB DB** | Pod/External | 存储高级网络配置 | - |
| **OVN SB DB** | Pod/External | 存储逻辑流表 | - |
| **ovn-controller** | 每节点 | 编程 OVS 流表 | - |


### 2.3 项目目录结构

```
zstack-ovn-kubernetes/
├── api/                              # CRD API 定义
│   └── v1/
│       ├── groupversion_info.go      # API 组版本信息
│       └── subnet_types.go           # Subnet CRD 类型定义
│
├── cmd/                              # 入口程序
│   ├── zstack-ovnkube-controller/    # 控制器入口
│   │   └── main.go
│   ├── zstack-ovnkube-node/          # 节点代理入口
│   │   └── main.go
│   └── zstack-ovn-cni/               # CNI 插件入口
│       └── main.go
│
├── pkg/                              # 核心逻辑
│   ├── allocator/                    # IP 分配器
│   │   ├── bitmap.go                 # Bitmap 数据结构
│   │   ├── subnet_allocator.go       # 子网 IP 分配
│   │   └── errors.go                 # 错误定义
│   │
│   ├── cni/                          # CNI 实现
│   │   ├── cni.go                    # CNI 命令处理
│   │   ├── cniserver.go              # CNI Server
│   │   ├── handler.go                # 请求处理器
│   │   └── helper_linux.go           # Linux 网络配置
│   │
│   ├── config/                       # 配置管理
│   │   ├── config.go                 # 配置结构
│   │   └── cni.go                    # CNI 配置
│   │
│   ├── node/                         # 节点网络
│   │   ├── node_controller.go        # 节点控制器
│   │   ├── gateway.go                # 网关配置
│   │   └── tunnel.go                 # 隧道配置
│   │
│   ├── ovn/                          # OVN 控制器
│   │   ├── controller.go             # 主控制器
│   │   ├── subnet_controller.go      # 子网控制器
│   │   ├── pod_controller.go         # Pod 控制器
│   │   ├── service_controller.go     # Service 控制器
│   │   └── policy_controller.go      # NetworkPolicy 控制器
│   │
│   ├── ovndb/                        # OVN 数据库操作
│   │   ├── client.go                 # OVN 客户端
│   │   ├── logical_switch.go         # Logical Switch 操作
│   │   ├── logical_switch_port.go    # LSP 操作
│   │   ├── load_balancer.go          # Load Balancer 操作
│   │   ├── acl.go                    # ACL 操作
│   │   ├── external.go               # 外部模式支持
│   │   └── zstack.go                 # ZStack 兼容性
│   │
│   ├── types/                        # 类型定义
│   │   └── constants.go              # 常量
│   │
│   └── util/                         # 工具函数
│       ├── annotation.go             # Pod Annotation
│       └── net.go                    # 网络工具
│
├── deploy/                           # 部署配置
│   ├── helm/                         # Helm Chart
│   │   ├── Chart.yaml
│   │   ├── values.yaml               # 默认配置
│   │   ├── values-standalone.yaml    # Standalone 模式
│   │   ├── values-standalone-ha.yaml # Standalone HA 模式
│   │   ├── values-external.yaml      # External 模式
│   │   └── templates/                # 模板文件
│   │
│   ├── standalone/                   # Standalone 部署
│   │   ├── single/                   # 单节点模式
│   │   └── ha/                       # 高可用模式
│   │
│   └── yaml/                         # 原始 YAML
│
├── examples/                         # 配置示例
│   ├── overlay-network/              # Overlay 网络
│   ├── underlay-network/             # Underlay 网络
│   └── network-policy/               # NetworkPolicy
│
├── docs/                             # 文档
│   ├── architecture.md               # 架构文档
│   ├── deployment.md                 # 部署指南
│   ├── configuration.md              # 配置说明
│   ├── troubleshooting.md            # 故障排查
│   └── technical-guide.md            # 技术文档 (本文档)
│
├── test/                             # 测试
│   ├── unit/                         # 单元测试
│   ├── integration/                  # 集成测试
│   └── e2e/                          # E2E 测试
│
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

---

## 3. 核心组件详解

### 3.1 OVN 客户端 (pkg/ovndb)

OVN 客户端封装了对 OVN Northbound 和 Southbound 数据库的操作。

#### 3.1.1 客户端架构

```
┌─────────────────────────────────────────────────────────────┐
│                      OVN Client                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │                   Connection Layer                   │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │    │
│  │  │ TCP Connect │  │ SSL Connect │  │   Retry     │  │    │
│  │  │             │  │             │  │  (Backoff)  │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│                            │                                 │
│  ┌─────────────────────────┴───────────────────────────┐    │
│  │                   Operation Layer                    │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐         │    │
│  │  │ Logical   │ │   Load    │ │    ACL    │         │    │
│  │  │  Switch   │ │ Balancer  │ │           │         │    │
│  │  └───────────┘ └───────────┘ └───────────┘         │    │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐         │    │
│  │  │ Logical   │ │   LSP     │ │  Router   │         │    │
│  │  │  Router   │ │           │ │   Port    │         │    │
│  │  └───────────┘ └───────────┘ └───────────┘         │    │
│  └─────────────────────────────────────────────────────┘    │
│                            │                                 │
│  ┌─────────────────────────┴───────────────────────────┐    │
│  │                  Transaction Layer                   │    │
│  │  ┌─────────────────────────────────────────────┐    │    │
│  │  │  Atomic Operations  │  Optimistic Locking   │    │    │
│  │  └─────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```


#### 3.1.2 核心接口

```go
// OVN 客户端接口
type Client interface {
    // Logical Switch 操作
    CreateLogicalSwitch(name string, subnet string, excludeIPs []string) error
    GetLogicalSwitch(name string) (*LogicalSwitch, error)
    DeleteLogicalSwitch(name string) error
    
    // Logical Switch Port 操作
    CreateLogicalSwitchPort(switchName, portName, mac string, ips []string) error
    GetLogicalSwitchPort(name string) (*LogicalSwitchPort, error)
    DeleteLogicalSwitchPort(name string) error
    
    // Load Balancer 操作
    CreateLoadBalancer(name, vip string, backends []string, protocol string) error
    UpdateLoadBalancer(name string, vips map[string]string) error
    DeleteLoadBalancer(name string) error
    
    // ACL 操作
    CreateACL(switchName, direction string, priority int, match, action string) error
    DeleteACL(switchName, direction string, priority int, match string) error
}
```

### 3.2 IP 分配器 (pkg/allocator)

IP 分配器使用 Bitmap 算法高效管理 IP 地址分配。

#### 3.2.1 Bitmap 分配算法

```
┌─────────────────────────────────────────────────────────────┐
│                    Subnet: 10.244.0.0/24                     │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Bitmap (256 bits):                                          │
│  ┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐  │
│  │1│1│0│0│1│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│0│  │
│  └─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘  │
│   ↑ ↑     ↑                                                  │
│   │ │     │                                                  │
│   │ │     └── 10.244.0.4 (已分配给 Pod)                      │
│   │ └──────── 10.244.0.1 (网关，已排除)                      │
│   └────────── 10.244.0.0 (网络地址，已排除)                  │
│                                                              │
│  操作:                                                       │
│  - AllocateNext(): 找到第一个为 0 的位，设为 1，返回对应 IP  │
│  - Allocate(ip):   将指定 IP 对应的位设为 1                  │
│  - Release(ip):    将指定 IP 对应的位设为 0                  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.2 分配流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Pod 创建    │────▶│  检查子网    │────▶│  分配 IP     │
└──────────────┘     └──────────────┘     └──────┬───────┘
                                                  │
                     ┌──────────────┐             │
                     │  更新 Bitmap │◀────────────┘
                     └──────┬───────┘
                            │
                     ┌──────▼───────┐
                     │  返回 IP     │
                     └──────────────┘
```

### 3.3 CNI 插件 (pkg/cni)

CNI 插件实现标准 CNI 规范，处理 Pod 网络的创建和删除。

#### 3.3.1 CNI 处理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         CNI ADD 命令处理流程                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐          │
│  │ kubelet  │───▶│ CNI 二进制│───▶│CNI Server│───▶│Controller│          │
│  │          │    │          │    │(Unix Sock)│    │          │          │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘          │
│       │                               │                │                 │
│       │                               │                │                 │
│       ▼                               ▼                ▼                 │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                        处理步骤                                   │   │
│  │                                                                   │   │
│  │  1. 解析 CNI 配置                                                 │   │
│  │     └── 读取 /etc/cni/net.d/10-zstack-ovn.conflist               │   │
│  │                                                                   │   │
│  │  2. 等待 Pod Annotation                                           │   │
│  │     └── 等待 Controller 分配 IP 并写入 Annotation                 │   │
│  │                                                                   │   │
│  │  3. 创建 veth pair                                                │   │
│  │     └── 一端在容器内 (eth0)，一端在宿主机 (vethXXX)              │   │
│  │                                                                   │   │
│  │  4. 配置容器网络                                                  │   │
│  │     ├── 设置 IP 地址                                              │   │
│  │     ├── 设置默认网关                                              │   │
│  │     └── 配置路由                                                  │   │
│  │                                                                   │   │
│  │  5. 将 host veth 加入 OVS br-int                                  │   │
│  │     └── ovs-vsctl add-port br-int vethXXX                        │   │
│  │                                                                   │   │
│  │  6. 返回 CNI Result                                               │   │
│  │     └── 包含 IP、网关、路由信息                                   │   │
│  │                                                                   │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```


#### 3.3.2 CNI DEL 命令处理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         CNI DEL 命令处理流程                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐          │
│  │ kubelet  │───▶│ CNI 二进制│───▶│CNI Server│───▶│Controller│          │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘          │
│                                                                          │
│  处理步骤:                                                               │
│                                                                          │
│  1. 从 OVS br-int 移除端口                                              │
│     └── ovs-vsctl del-port br-int vethXXX                               │
│                                                                          │
│  2. 删除 veth pair                                                       │
│     └── ip link delete vethXXX                                          │
│                                                                          │
│  3. 删除 OVN Logical Switch Port                                        │
│     └── ovn-nbctl lsp-del <port-name>                                   │
│                                                                          │
│  4. 释放 IP 地址                                                         │
│     └── 更新 Bitmap，将对应位设为 0                                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 控制器 (pkg/ovn)

#### 3.4.1 Subnet 控制器

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Subnet Controller 工作流程                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐                                                        │
│  │ Watch Subnet │                                                        │
│  │     CRD      │                                                        │
│  └──────┬───────┘                                                        │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │   Reconcile  │────▶│ 检查部署模式 │────▶│  Standalone? │            │
│  └──────────────┘     └──────────────┘     └──────┬───────┘            │
│                                                    │                     │
│                              ┌────────────────────┴────────────────┐    │
│                              │                                      │    │
│                              ▼                                      ▼    │
│                       ┌──────────────┐                      ┌──────────────┐
│                       │  Standalone  │                      │   External   │
│                       │    模式      │                      │    模式      │
│                       └──────┬───────┘                      └──────┬───────┘
│                              │                                      │    │
│                              ▼                                      ▼    │
│                       ┌──────────────┐                      ┌──────────────┐
│                       │ 创建 OVN LS  │                      │ 验证外部 LS  │
│                       │              │                      │   是否存在   │
│                       └──────┬───────┘                      └──────┬───────┘
│                              │                                      │    │
│                              └────────────────┬─────────────────────┘    │
│                                               │                          │
│                                               ▼                          │
│                                        ┌──────────────┐                  │
│                                        │ 更新 Subnet  │                  │
│                                        │    Status    │                  │
│                                        └──────────────┘                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.4.2 Service 控制器

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Service Controller 工作流程                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │Watch Service │────▶│Watch Endpoint│────▶│   Reconcile  │            │
│  └──────────────┘     └──────────────┘     └──────┬───────┘            │
│                                                    │                     │
│                                                    ▼                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    Service 类型判断                              │    │
│  │                                                                  │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │    │
│  │  │  ClusterIP  │  │  NodePort   │  │LoadBalancer │              │    │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │    │
│  │         │                │                │                      │    │
│  │         ▼                ▼                ▼                      │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │              创建/更新 OVN Load Balancer                 │    │    │
│  │  │                                                          │    │    │
│  │  │  VIP: ClusterIP:Port                                     │    │    │
│  │  │  Backends: [PodIP1:Port, PodIP2:Port, ...]              │    │    │
│  │  │  Protocol: TCP/UDP                                       │    │    │
│  │  │                                                          │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  OVN Load Balancer 示例:                                                │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  Name: kubernetes-service-nginx                                  │    │
│  │  VIPs: {                                                         │    │
│  │    "10.96.0.100:80": "10.244.1.5:8080,10.244.2.6:8080"         │    │
│  │  }                                                               │    │
│  │  Protocol: tcp                                                   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```


#### 3.4.3 NetworkPolicy 控制器

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   NetworkPolicy Controller 工作流程                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐                                                        │
│  │    Watch     │                                                        │
│  │NetworkPolicy │                                                        │
│  └──────┬───────┘                                                        │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐            │
│  │   Reconcile  │────▶│  解析规则    │────▶│ 生成 ACL     │            │
│  └──────────────┘     └──────────────┘     └──────┬───────┘            │
│                                                    │                     │
│                                                    ▼                     │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                      ACL 规则生成                                │    │
│  │                                                                  │    │
│  │  NetworkPolicy:                    OVN ACL:                      │    │
│  │  ┌─────────────────────┐          ┌─────────────────────────┐   │    │
│  │  │ podSelector:        │          │ Direction: to-lport     │   │    │
│  │  │   app: web          │   ───▶   │ Priority: 1000          │   │    │
│  │  │ ingress:            │          │ Match: ip4.src==10.244. │   │    │
│  │  │ - from:             │          │        0.0/16 && tcp.   │   │    │
│  │  │   - podSelector:    │          │        dst==80          │   │    │
│  │  │       app: api      │          │ Action: allow           │   │    │
│  │  │   ports:            │          └─────────────────────────┘   │    │
│  │  │   - port: 80        │                                        │    │
│  │  └─────────────────────┘                                        │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ACL 优先级规则:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │  优先级      │  用途                                             │    │
│  │  ──────────────────────────────────────────────────────────────  │    │
│  │  32767      │  默认允许 (无 NetworkPolicy 时)                    │    │
│  │  1000-2000  │  NetworkPolicy 允许规则                            │    │
│  │  0          │  默认拒绝 (有 NetworkPolicy 时)                    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 数据流程图

### 4.1 Pod 创建完整流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Pod 创建完整流程                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────┐                                                                     │
│  │  User   │                                                                     │
│  │ kubectl │                                                                     │
│  └────┬────┘                                                                     │
│       │ 1. kubectl apply -f pod.yaml                                            │
│       ▼                                                                          │
│  ┌─────────┐                                                                     │
│  │  API    │                                                                     │
│  │ Server  │                                                                     │
│  └────┬────┘                                                                     │
│       │ 2. 存储 Pod 对象                                                         │
│       │                                                                          │
│       ├──────────────────────────────────────────────────────────────┐          │
│       │                                                               │          │
│       ▼                                                               ▼          │
│  ┌─────────────────────┐                                    ┌─────────────────┐ │
│  │   Scheduler         │                                    │  Pod Controller │ │
│  │                     │                                    │  (我们的组件)   │ │
│  └──────────┬──────────┘                                    └────────┬────────┘ │
│             │ 3. 调度到节点                                          │          │
│             │                                                        │          │
│             ▼                                                        │          │
│  ┌─────────────────────┐                                             │          │
│  │   kubelet           │                                             │          │
│  │   (目标节点)        │                                             │          │
│  └──────────┬──────────┘                                             │          │
│             │ 4. 创建容器                                            │          │
│             │                                                        │          │
│             ▼                                                        │          │
│  ┌─────────────────────┐                                             │          │
│  │   CNI Plugin        │◀────────────────────────────────────────────┘          │
│  │   (zstack-ovn-cni)  │     5. 分配 IP，创建 LSP，更新 Annotation              │
│  └──────────┬──────────┘                                                        │
│             │ 6. 调用 CNI ADD                                                   │
│             │                                                                    │
│             ▼                                                                    │
│  ┌─────────────────────┐                                                        │
│  │   CNI Server        │                                                        │
│  │   (Node Agent)      │                                                        │
│  └──────────┬──────────┘                                                        │
│             │ 7. 等待 Annotation                                                │
│             │ 8. 创建 veth pair                                                 │
│             │ 9. 配置容器网络                                                   │
│             │ 10. 加入 OVS br-int                                               │
│             │                                                                    │
│             ▼                                                                    │
│  ┌─────────────────────┐                                                        │
│  │   OVS + ovn-ctrl    │                                                        │
│  │                     │                                                        │
│  └──────────┬──────────┘                                                        │
│             │ 11. 下发流表                                                      │
│             │                                                                    │
│             ▼                                                                    │
│  ┌─────────────────────┐                                                        │
│  │   Pod 网络就绪      │                                                        │
│  │   ✓ IP 已分配       │                                                        │
│  │   ✓ 网络已配置      │                                                        │
│  │   ✓ 可以通信        │                                                        │
│  └─────────────────────┘                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```


### 4.2 Pod 间通信流程

#### 4.2.1 同节点 Pod 通信

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          同节点 Pod 通信流程                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Node 1                                                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                            │  │
│  │  ┌─────────────┐                              ┌─────────────┐             │  │
│  │  │   Pod A     │                              │   Pod B     │             │  │
│  │  │ 10.244.1.5  │                              │ 10.244.1.6  │             │  │
│  │  │  ┌──────┐   │                              │  ┌──────┐   │             │  │
│  │  │  │ eth0 │   │                              │  │ eth0 │   │             │  │
│  │  │  └──┬───┘   │                              │  └──┬───┘   │             │  │
│  │  └─────┼───────┘                              └─────┼───────┘             │  │
│  │        │                                            │                      │  │
│  │        │ veth-a                              veth-b │                      │  │
│  │        │                                            │                      │  │
│  │  ┌─────┴────────────────────────────────────────────┴─────┐               │  │
│  │  │                        br-int                           │               │  │
│  │  │                                                         │               │  │
│  │  │  流表匹配:                                              │               │  │
│  │  │  1. 入口: in_port=veth-a, ip_dst=10.244.1.6            │               │  │
│  │  │  2. 查表: 目标 MAC 对应 veth-b                          │               │  │
│  │  │  3. 出口: output:veth-b                                 │               │  │
│  │  │                                                         │               │  │
│  │  └─────────────────────────────────────────────────────────┘               │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  数据包路径: Pod A eth0 → veth-a → br-int → veth-b → Pod B eth0                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 跨节点 Pod 通信

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          跨节点 Pod 通信流程                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Node 1 (192.168.1.10)                    Node 2 (192.168.1.11)                 │
│  ┌─────────────────────────┐              ┌─────────────────────────┐           │
│  │  ┌─────────────┐        │              │        ┌─────────────┐  │           │
│  │  │   Pod A     │        │              │        │   Pod B     │  │           │
│  │  │ 10.244.1.5  │        │              │        │ 10.244.2.6  │  │           │
│  │  │  ┌──────┐   │        │              │        │  ┌──────┐   │  │           │
│  │  │  │ eth0 │   │        │              │        │  │ eth0 │   │  │           │
│  │  │  └──┬───┘   │        │              │        │  └──┬───┘   │  │           │
│  │  └─────┼───────┘        │              │        └─────┼───────┘  │           │
│  │        │                │              │              │          │           │
│  │  ┌─────┴─────┐          │              │        ┌─────┴─────┐    │           │
│  │  │  br-int   │          │              │        │  br-int   │    │           │
│  │  └─────┬─────┘          │              │        └─────┬─────┘    │           │
│  │        │                │              │              │          │           │
│  │  ┌─────┴─────┐          │              │        ┌─────┴─────┐    │           │
│  │  │  vxlan0   │          │              │        │  vxlan0   │    │           │
│  │  │ (隧道端口) │          │              │        │ (隧道端口) │    │           │
│  │  └─────┬─────┘          │              │        └─────┬─────┘    │           │
│  │        │                │              │              │          │           │
│  │  ┌─────┴─────┐          │              │        ┌─────┴─────┐    │           │
│  │  │   eth0    │          │              │        │   eth0    │    │           │
│  │  │192.168.1.10│         │              │        │192.168.1.11│   │           │
│  │  └─────┬─────┘          │              │        └─────┬─────┘    │           │
│  └────────┼────────────────┘              └──────────────┼──────────┘           │
│           │                                              │                       │
│           │              Physical Network                │                       │
│           └──────────────────────────────────────────────┘                       │
│                                                                                  │
│  VXLAN 封装:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Outer IP Header  │  UDP Header  │  VXLAN Header  │  Inner Ethernet    │    │
│  │  Src: 192.168.1.10│  Dst: 4789   │  VNI: 100      │  Src: Pod A MAC    │    │
│  │  Dst: 192.168.1.11│              │                │  Dst: Pod B MAC    │    │
│  │                   │              │                │  Inner IP: 10.244  │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Service 访问流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Service 访问流程 (ClusterIP)                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────┐                                                                │
│  │  Client Pod │                                                                │
│  │ 10.244.1.5  │                                                                │
│  └──────┬──────┘                                                                │
│         │ 1. 访问 Service: 10.96.0.100:80                                       │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           OVS br-int                                     │    │
│  │                                                                          │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │    │
│  │  │                    OVN Load Balancer                             │    │    │
│  │  │                                                                  │    │    │
│  │  │  VIP: 10.96.0.100:80                                            │    │    │
│  │  │  Backends:                                                       │    │    │
│  │  │    - 10.244.1.10:8080 (Pod 1)                                   │    │    │
│  │  │    - 10.244.2.20:8080 (Pod 2)                                   │    │    │
│  │  │    - 10.244.3.30:8080 (Pod 3)                                   │    │    │
│  │  │                                                                  │    │    │
│  │  │  负载均衡算法: Round Robin                                       │    │    │
│  │  │                                                                  │    │    │
│  │  └─────────────────────────────────────────────────────────────────┘    │    │
│  │                                                                          │    │
│  │  2. DNAT: 10.96.0.100:80 → 10.244.2.20:8080                            │    │
│  │                                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         │ 3. 转发到后端 Pod                                                     │
│         ▼                                                                        │
│  ┌─────────────┐                                                                │
│  │ Backend Pod │                                                                │
│  │ 10.244.2.20 │                                                                │
│  └─────────────┘                                                                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```


---

## 5. 部署模式

### 5.1 Standalone 模式

Standalone 模式下，CNI 自动部署和管理 OVN 数据库组件。

#### 5.1.1 单节点模式架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Standalone 单节点模式架构                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         Control Plane                                      │  │
│  │                                                                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │   NB DB     │  │   SB DB     │  │   northd    │                        │  │
│  │  │ (Pod/单实例) │  │ (Pod/单实例) │  │ (Deployment)│                        │  │
│  │  │   :6641     │  │   :6642     │  │             │                        │  │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                        │  │
│  │         │                │                │                                │  │
│  │         └────────────────┴────────────────┘                                │  │
│  │                          │                                                 │  │
│  │                   ┌──────┴──────┐                                          │  │
│  │                   │  ClusterIP  │                                          │  │
│  │                   │  Services   │                                          │  │
│  │                   └──────┬──────┘                                          │  │
│  │                          │                                                 │  │
│  └──────────────────────────┼─────────────────────────────────────────────────┘  │
│                             │                                                    │
│  ┌──────────────────────────┼─────────────────────────────────────────────────┐  │
│  │                    Worker Nodes                                             │  │
│  │                          │                                                  │  │
│  │  ┌───────────────────────┼───────────────────────────────────────────────┐ │  │
│  │  │              ovn-controller (DaemonSet)                                │ │  │
│  │  │                       │                                                │ │  │
│  │  │  ┌─────────┐  ┌──────┴──────┐  ┌─────────┐                            │ │  │
│  │  │  │ node-1  │  │   node-2    │  │ node-3  │                            │ │  │
│  │  │  └─────────┘  └─────────────┘  └─────────┘                            │ │  │
│  │  └────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                             │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
│  适用场景: 开发、测试、学习环境                                                  │
│  特点: 部署简单，无高可用                                                        │
│                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 5.1.2 高可用模式架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Standalone 高可用模式架构                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                      OVN Database Raft Cluster                             │  │
│  │                                                                            │  │
│  │  NB DB Cluster (3 节点 Raft)                                              │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │  nb-db-0    │  │  nb-db-1    │  │  nb-db-2    │                        │  │
│  │  │  (Leader)   │◀─▶│ (Follower)  │◀─▶│ (Follower)  │                        │  │
│  │  │   :6641     │  │   :6641     │  │   :6641     │                        │  │
│  │  │   :6643     │  │   :6643     │  │   :6643     │                        │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                        │  │
│  │                                                                            │  │
│  │  SB DB Cluster (3 节点 Raft)                                              │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │  sb-db-0    │  │  sb-db-1    │  │  sb-db-2    │                        │  │
│  │  │  (Leader)   │◀─▶│ (Follower)  │◀─▶│ (Follower)  │                        │  │
│  │  │   :6642     │  │   :6642     │  │   :6642     │                        │  │
│  │  │   :6644     │  │   :6644     │  │   :6644     │                        │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                        │  │
│  │                                                                            │  │
│  │  northd (2 副本，主备模式)                                                 │  │
│  │  ┌─────────────┐  ┌─────────────┐                                         │  │
│  │  │  northd-0   │  │  northd-1   │                                         │  │
│  │  │  (Active)   │  │  (Standby)  │                                         │  │
│  │  └─────────────┘  └─────────────┘                                         │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  Raft 端口说明:                                                                 │
│  - 6641/6642: 客户端连接端口                                                    │
│  - 6643/6644: Raft 集群通信端口                                                 │
│                                                                                  │
│  故障容忍: 可容忍 1 个节点故障                                                  │
│  适用场景: 生产环境                                                             │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 External 模式

External 模式连接到 ZStack 管理的外部 OVN 数据库。

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           External 模式架构                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         ZStack Platform                                    │  │
│  │                                                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    ZStack OVN Database                               │  │  │
│  │  │                                                                      │  │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │  │  │
│  │  │  │   NB DB     │  │   SB DB     │  │   northd    │                  │  │  │
│  │  │  │ :6641 (TCP) │  │ :6642 (TCP) │  │             │                  │  │  │
│  │  │  │ :6641 (SSL) │  │ :6642 (SSL) │  │             │                  │  │  │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘                  │  │  │
│  │  │                                                                      │  │  │
│  │  │  已有的 OVN 对象:                                                    │  │  │
│  │  │  - Logical Switches (VM 网络)                                        │  │  │
│  │  │  - Logical Routers (VPC 路由)                                        │  │  │
│  │  │  - ACLs (安全组)                                                     │  │  │
│  │  │                                                                      │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    ZStack VMs                                        │  │  │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                              │  │  │
│  │  │  │  VM 1   │  │  VM 2   │  │  VM 3   │                              │  │  │
│  │  │  │10.100.1.│  │10.100.1.│  │10.100.1.│                              │  │  │
│  │  │  │   10    │  │   11    │  │   12    │                              │  │  │
│  │  │  └─────────┘  └─────────┘  └─────────┘                              │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                           │
│                                      │ TCP/SSL 连接                              │
│                                      │                                           │
│  ┌───────────────────────────────────┼───────────────────────────────────────┐  │
│  │                    Kubernetes Cluster                                      │  │
│  │                                   │                                        │  │
│  │  ┌────────────────────────────────┼────────────────────────────────────┐  │  │
│  │  │         zstack-ovnkube-controller                                   │  │  │
│  │  │                                │                                    │  │  │
│  │  │  - 连接外部 OVN 数据库                                              │  │  │
│  │  │  - 不启动本地 OVN 进程                                              │  │  │
│  │  │  - 可引用 ZStack 已有的 Logical Switch                              │  │  │
│  │  │  - 确保不与 ZStack 配置冲突                                         │  │  │
│  │  │                                                                     │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    Kubernetes Pods                                   │  │  │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                              │  │  │
│  │  │  │  Pod 1  │  │  Pod 2  │  │  Pod 3  │                              │  │  │
│  │  │  │10.100.1.│  │10.100.1.│  │10.100.1.│                              │  │  │
│  │  │  │   20    │  │   21    │  │   22    │                              │  │  │
│  │  │  └─────────┘  └─────────┘  └─────────┘                              │  │  │
│  │  │                                                                      │  │  │
│  │  │  Pod 与 VM 在同一网络平面，可直接通信                                │  │  │
│  │  │                                                                      │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                            │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```


### 5.3 部署模式对比

| 特性 | Standalone 单节点 | Standalone HA | External |
|------|-------------------|---------------|----------|
| OVN 数据库 | 自管理 (单实例) | 自管理 (Raft 集群) | 外部 (ZStack) |
| 高可用 | ✗ | ✓ | 取决于 ZStack |
| VM-Pod 互通 | ✗ | ✗ | ✓ |
| 部署复杂度 | 低 | 中 | 低 |
| 资源消耗 | 低 | 高 | 低 |
| 适用场景 | 开发/测试 | 独立生产环境 | ZStack 集成 |

---

## 6. 核心功能实现

### 6.1 Subnet CRD

#### 6.1.1 CRD 定义

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: subnets.network.zstack.io
spec:
  group: network.zstack.io
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - cidr
                - gateway
              properties:
                cidr:
                  type: string
                  description: "子网 CIDR，如 10.244.0.0/16"
                gateway:
                  type: string
                  description: "网关 IP"
                excludeIPs:
                  type: array
                  items:
                    type: string
                  description: "排除的 IP 地址列表"
                externalLogicalSwitch:
                  type: string
                  description: "外部 Logical Switch 名称 (External 模式)"
                vlanID:
                  type: integer
                  minimum: 1
                  maximum: 4094
                  description: "VLAN ID (Underlay 网络)"
                provider:
                  type: string
                  description: "Provider Network 名称"
                protocol:
                  type: string
                  enum: ["IPv4", "IPv6", "Dual"]
                  default: "IPv4"
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: ["Pending", "Active", "Failed"]
                reason:
                  type: string
                availableIPs:
                  type: integer
                usedIPs:
                  type: integer
                logicalSwitch:
                  type: string
  scope: Cluster
  names:
    plural: subnets
    singular: subnet
    kind: Subnet
    shortNames:
      - sn
```

#### 6.1.2 Subnet 示例

```yaml
# Overlay 网络子网
apiVersion: network.zstack.io/v1
kind: Subnet
metadata:
  name: pod-subnet
spec:
  cidr: "10.244.0.0/16"
  gateway: "10.244.0.1"
  excludeIPs:
    - "10.244.0.1"
    - "10.244.0.2-10.244.0.10"
  protocol: IPv4

---
# Underlay 网络子网
apiVersion: network.zstack.io/v1
kind: Subnet
metadata:
  name: underlay-subnet
spec:
  cidr: "192.168.100.0/24"
  gateway: "192.168.100.1"
  excludeIPs:
    - "192.168.100.1"
  vlanID: 100
  provider: "provider-net1"

---
# External 模式子网 (引用 ZStack Logical Switch)
apiVersion: network.zstack.io/v1
kind: Subnet
metadata:
  name: zstack-subnet
spec:
  cidr: "10.100.0.0/24"
  gateway: "10.100.0.1"
  externalLogicalSwitch: "ls-zstack-vpc-subnet-uuid"
  excludeIPs:
    - "10.100.0.1"
    - "10.100.0.100-10.100.0.200"  # ZStack VM 使用的范围
```

### 6.2 Pod Annotation

Pod 网络配置信息存储在 Annotation 中：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
  annotations:
    # 网络配置 Annotation
    k8s.ovn.org/pod-networks: |
      {
        "default": {
          "ip_addresses": ["10.244.1.5/24"],
          "mac_address": "0a:58:0a:f4:01:05",
          "gateway_ips": ["10.244.1.1"],
          "routes": [
            {"dest": "10.96.0.0/16", "nextHop": "10.244.1.1"}
          ]
        }
      }
spec:
  containers:
  - name: app
    image: nginx
```

### 6.3 OVN 对象映射

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      Kubernetes 到 OVN 对象映射                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Kubernetes 资源                    OVN 对象                                    │
│  ─────────────────────────────────────────────────────────────────────────────  │
│                                                                                  │
│  ┌─────────────┐                   ┌─────────────────────────────────────────┐  │
│  │   Subnet    │  ───────────────▶ │  Logical Switch                         │  │
│  │   CRD       │                   │  - name: subnet-<name>                  │  │
│  └─────────────┘                   │  - other_config: {subnet: "10.244.0.0/16"}│  │
│                                    └─────────────────────────────────────────┘  │
│                                                                                  │
│  ┌─────────────┐                   ┌─────────────────────────────────────────┐  │
│  │    Pod      │  ───────────────▶ │  Logical Switch Port                    │  │
│  │             │                   │  - name: <namespace>_<pod-name>         │  │
│  └─────────────┘                   │  - addresses: ["MAC IP"]                │  │
│                                    │  - external_ids: {namespace, pod}       │  │
│                                    └─────────────────────────────────────────┘  │
│                                                                                  │
│  ┌─────────────┐                   ┌─────────────────────────────────────────┐  │
│  │   Service   │  ───────────────▶ │  Load Balancer                          │  │
│  │             │                   │  - name: k8s-<namespace>-<svc-name>     │  │
│  └─────────────┘                   │  - vips: {"ClusterIP:Port": "backends"} │  │
│                                    │  - protocol: tcp/udp                    │  │
│                                    └─────────────────────────────────────────┘  │
│                                                                                  │
│  ┌─────────────┐                   ┌─────────────────────────────────────────┐  │
│  │ NetworkPolicy│ ───────────────▶ │  ACL                                    │  │
│  │             │                   │  - direction: to-lport/from-lport       │  │
│  └─────────────┘                   │  - priority: 1000                       │  │
│                                    │  - match: "ip4.src == ..."              │  │
│                                    │  - action: allow/drop                   │  │
│                                    └─────────────────────────────────────────┘  │
│                                                                                  │
│  ┌─────────────┐                   ┌─────────────────────────────────────────┐  │
│  │    Node     │  ───────────────▶ │  Chassis                                │  │
│  │             │                   │  - name: <node-name>                    │  │
│  └─────────────┘                   │  - hostname: <node-hostname>            │  │
│                                    │  - encaps: [vxlan, geneve]              │  │
│                                    └─────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```


---

## 7. API 参考

### 7.1 Subnet API

#### 创建子网

```bash
kubectl apply -f - <<EOF
apiVersion: network.zstack.io/v1
kind: Subnet
metadata:
  name: my-subnet
spec:
  cidr: "10.244.0.0/16"
  gateway: "10.244.0.1"
  excludeIPs:
    - "10.244.0.1"
EOF
```

#### 查看子网

```bash
# 列出所有子网
kubectl get subnet

# 查看子网详情
kubectl describe subnet my-subnet

# 以 YAML 格式输出
kubectl get subnet my-subnet -o yaml
```

#### 删除子网

```bash
kubectl delete subnet my-subnet
```

### 7.2 OVN 命令参考

#### NB DB 操作

```bash
# 进入 NB DB Pod
kubectl -n kube-system exec -it deploy/ovn-nb-db -- bash

# 查看所有 Logical Switch
ovn-nbctl ls-list

# 查看 Logical Switch 详情
ovn-nbctl show

# 查看 Logical Switch Port
ovn-nbctl lsp-list <switch-name>

# 查看 Load Balancer
ovn-nbctl lb-list

# 查看 ACL
ovn-nbctl acl-list <switch-name>
```

#### SB DB 操作

```bash
# 进入 SB DB Pod
kubectl -n kube-system exec -it deploy/ovn-sb-db -- bash

# 查看 Chassis
ovn-sbctl show

# 查看端口绑定
ovn-sbctl list Port_Binding

# 查看逻辑流
ovn-sbctl lflow-list
```

#### OVS 操作

```bash
# 查看 OVS 配置
ovs-vsctl show

# 查看网桥端口
ovs-vsctl list-ports br-int

# 查看流表
ovs-ofctl dump-flows br-int

# 查看端口统计
ovs-ofctl dump-ports br-int
```

---

## 8. 配置参考

### 8.1 Helm Values 完整参考

```yaml
# OVN 配置
ovn:
  # 部署模式: standalone | external
  mode: standalone
  
  # 外部数据库地址 (external 模式必填)
  nbdbAddress: ""
  sbdbAddress: ""
  
  # SSL 配置
  ssl:
    enabled: false
    caCert: ""
    clientCert: ""
    clientKey: ""
  
  # Standalone 模式配置
  standalone:
    haMode: single  # single | ha
    image:
      repository: ghcr.io/ovn-org/ovn-kubernetes/ovn-kube-ubuntu
      tag: master
    nbdb:
      replicas: 1
      storage:
        enabled: false
        size: 1Gi
    sbdb:
      replicas: 1
      storage:
        enabled: false
        size: 1Gi
    northd:
      replicas: 1

# 网络配置
network:
  clusterCIDR: "10.244.0.0/16"
  serviceCIDR: "10.96.0.0/16"
  nodeSubnetSize: 24
  mtu: 0  # 0 = 自动检测

# 网关配置
gateway:
  mode: local  # shared | local
  interface: ""

# 隧道配置
tunnel:
  type: vxlan  # vxlan | geneve
  port: 4789

# DPDK 配置
dpdk:
  enabled: false
  socketDir: "/var/run/openvswitch"

# Controller 配置
controller:
  replicas: 1
  image:
    repository: ghcr.io/jiayi-1994/zstack-ovnkube-controller
    tag: "0.1.0"
  resources:
    limits:
      cpu: 500m
      memory: 512Mi

# Node Agent 配置
node:
  image:
    repository: ghcr.io/jiayi-1994/zstack-ovnkube-node
    tag: "0.1.0"
  resources:
    limits:
      cpu: 500m
      memory: 512Mi

# 日志配置
logging:
  level: info  # debug | info | warn | error
  format: json  # json | text
```

### 8.2 环境变量参考

| 环境变量 | 说明 | 默认值 |
|----------|------|--------|
| `ZSTACK_OVN_MODE` | 部署模式 | standalone |
| `ZSTACK_OVN_NBDB_ADDRESS` | NB DB 地址 | - |
| `ZSTACK_OVN_SBDB_ADDRESS` | SB DB 地址 | - |
| `ZSTACK_CLUSTER_CIDR` | Pod 网络 CIDR | 10.244.0.0/16 |
| `ZSTACK_SERVICE_CIDR` | Service 网络 CIDR | 10.96.0.0/16 |
| `ZSTACK_GATEWAY_MODE` | 网关模式 | local |
| `ZSTACK_TUNNEL_TYPE` | 隧道类型 | vxlan |
| `ZSTACK_LOG_LEVEL` | 日志级别 | info |

---

## 9. 运维指南

### 9.1 健康检查

```bash
# 检查所有组件状态
kubectl -n kube-system get pods -l app.kubernetes.io/name=zstack-ovn-kubernetes

# 检查 Controller 健康
kubectl -n kube-system logs deploy/zstack-ovnkube-controller --tail=20

# 检查 Node Agent 健康
kubectl -n kube-system logs -l app=zstack-ovnkube-node --tail=20

# 检查 OVN 数据库连接
kubectl -n kube-system exec -it deploy/ovn-nb-db -- \
  ovsdb-client list-dbs tcp:127.0.0.1:6641
```

### 9.2 常见问题排查

#### Pod 无法获取 IP

```bash
# 1. 检查 CNI 配置
cat /etc/cni/net.d/10-zstack-ovn.conflist

# 2. 检查 CNI Server
ls -la /var/run/zstack-ovn/cni-server.sock

# 3. 检查子网状态
kubectl get subnet -o wide

# 4. 检查 Controller 日志
kubectl -n kube-system logs deploy/zstack-ovnkube-controller | grep -i error
```

#### Pod 间无法通信

```bash
# 1. 检查 OVN LSP
kubectl -n kube-system exec -it deploy/ovn-nb-db -- ovn-nbctl show

# 2. 检查端口绑定
kubectl -n kube-system exec -it deploy/ovn-sb-db -- ovn-sbctl show

# 3. 检查 OVS 流表
ovs-ofctl dump-flows br-int | grep <pod-ip>

# 4. 检查隧道状态
ovs-vsctl show | grep -A 5 vxlan
```

#### Service 无法访问

```bash
# 1. 检查 Service 和 Endpoints
kubectl get svc,endpoints <service-name>

# 2. 检查 OVN Load Balancer
kubectl -n kube-system exec -it deploy/ovn-nb-db -- ovn-nbctl lb-list

# 3. 检查 Controller 日志
kubectl -n kube-system logs deploy/zstack-ovnkube-controller | grep -i service
```

### 9.3 性能调优

#### OVS 调优

```bash
# 增加 OVS 处理线程
ovs-vsctl set Open_vSwitch . other_config:n-handler-threads=4
ovs-vsctl set Open_vSwitch . other_config:n-revalidator-threads=4

# 启用硬件卸载 (如果支持)
ovs-vsctl set Open_vSwitch . other_config:hw-offload=true
```

#### 网络调优

```bash
# 调整 MTU (减少分片)
# 在 values.yaml 中设置
network:
  mtu: 1400  # VXLAN 开销约 50 字节

# 调整隧道端口
tunnel:
  port: 4789
```

### 9.4 备份与恢复

#### 备份 OVN 数据库

```bash
# 备份 NB DB
kubectl -n kube-system exec -it ovn-nb-db-0 -- \
  ovsdb-client backup tcp:127.0.0.1:6641 > nb-backup.db

# 备份 SB DB
kubectl -n kube-system exec -it ovn-sb-db-0 -- \
  ovsdb-client backup tcp:127.0.0.1:6642 > sb-backup.db
```

#### 恢复 OVN 数据库

```bash
# 恢复 NB DB
kubectl -n kube-system exec -i ovn-nb-db-0 -- \
  ovsdb-client restore tcp:127.0.0.1:6641 < nb-backup.db

# 恢复 SB DB
kubectl -n kube-system exec -i ovn-sb-db-0 -- \
  ovsdb-client restore tcp:127.0.0.1:6642 < sb-backup.db
```

---

## 附录

### A. 术语表

| 术语 | 全称 | 说明 |
|------|------|------|
| CNI | Container Network Interface | 容器网络接口规范 |
| OVN | Open Virtual Networking | 开放虚拟网络 |
| OVS | Open vSwitch | 开放虚拟交换机 |
| NB DB | Northbound Database | 北向数据库 |
| SB DB | Southbound Database | 南向数据库 |
| LS | Logical Switch | 逻辑交换机 |
| LR | Logical Router | 逻辑路由器 |
| LSP | Logical Switch Port | 逻辑交换机端口 |
| ACL | Access Control List | 访问控制列表 |
| VIP | Virtual IP | 虚拟 IP |
| VXLAN | Virtual Extensible LAN | 虚拟可扩展局域网 |

### B. 参考资料

- [OVN-Kubernetes](https://github.com/ovn-org/ovn-kubernetes)
- [OVN Architecture](https://docs.ovn.org/en/latest/ref/ovn-architecture.7.html)
- [CNI Specification](https://github.com/containernetworking/cni/blob/master/SPEC.md)
- [Kubernetes Network Plugins](https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/)

### C. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 0.1.0 | 2024-01 | 初始版本 |

---

*本文档由 zstack-ovn-kubernetes 项目维护*
